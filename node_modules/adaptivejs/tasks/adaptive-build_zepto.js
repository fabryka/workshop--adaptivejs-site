var path = require('path');

module.exports = function(grunt) {
    // Change current working directory to this npm module's directory
    var parentcwd = process.cwd();
    process.chdir(path.join(__dirname, '../'));

    grunt.registerTask('adaptive-build_zepto', function() {
        var path = require('path');
        var done = this.async();
        var envCopy = {};
        var directory = path.join(process.cwd(), 'bower_components/zeptojs');

        // Copy env variables and add proper zepto modules to build
        for (var varName in process.env) {
          envCopy[varName] = process.env[varName];
        }

        var modules = grunt.option('modules') || 'zepto event ajax form fx selector stack data';
        envCopy.MODULES = modules;

        grunt.log.write('Building Zepto with the following modules: ' + modules);

        var installOptions = {
            cmd: 'npm',
            args: ['install'],
            opts: {
                cwd: directory,
            }
        };

        var buildOptions = {
            cmd: 'npm',
            args: ['run-script', 'dist'],
            opts: {
                cwd: directory,
                env: envCopy
            }
        };

        // First, do an `npm install` in the Zepto directory
        grunt.util.spawn(installOptions, function(error, result, code) {
            if (error) {
                grunt.log.error(error);
                done();
            }
            grunt.log.write(result);

            // Then, build zepto!
            grunt.util.spawn(buildOptions, function(error, result, code) {
                if (error) {
                    grunt.log.error(error);
                    done();
                }
                grunt.log.write(result);
                ['.js', '.min.js'].forEach(function(extension) {
                    var src = path.join(directory, 'dist/zepto' + extension);
                    var dest = path.join(process.cwd(), 'vendor', 'zepto' + extension);
                    grunt.file.copy(src, dest);
                });
                done();
            });

        });
    });

    // restore cwd
    process.chdir(parentcwd);
};
