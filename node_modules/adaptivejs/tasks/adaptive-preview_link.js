var os = require('os');

module.exports = function(grunt) {
    /**
     * Returns a string of the first outward facing IPv4 address
     * in the user's network interface for use with preview
     */
    var getLocalIP = function() {
        var interfaces = os.networkInterfaces();

        for (var netInterface in interfaces) {
            if (interfaces.hasOwnProperty(netInterface)) {
                for (var i = 0; i < interfaces[netInterface].length; i++) {
                    var netType = interfaces[netInterface][i];

                    if (netType.address !== undefined &&
                        netType.family === 'IPv4' &&
                        !netType.internal
                       ) {

                        return netType.address;
                    }
                }
            }
        }

        return 'localhost';
    };

    grunt.registerTask('adaptive-preview_link', function() {
        // Grab options
        var autoOpen = grunt.option('auto');
        var port = grunt.option('port') || 8080;
        var httpsPort = grunt.option('https-port') || 8443;

        // Grab site from package.json
        var packageJSON = require(process.cwd() + '/package.json');
        var siteUrl = packageJSON.siteUrl || '';
        var localAddress = getLocalIP();

        // Construct URLs
        var urlQueryString = 'url=' + encodeURIComponent(siteUrl);
        var bundleUrlQueryString = 'site_folder=' + encodeURIComponent('http://' + localAddress + ':' + port + '/adaptive.js');
        var secureBundleUrlQueryString = 'site_folder=' + encodeURIComponent('https://' + localAddress + ':' + httpsPort + '/adaptive.js');
        var partialPreviewUrl = 'https://preview.mobify.com/?';
        var previewUrl = partialPreviewUrl + [urlQueryString, bundleUrlQueryString].join('&');
        var securePreviewUrl = partialPreviewUrl + [urlQueryString, secureBundleUrlQueryString].join('&');

        console.log('\nDEVELOPING ON HTTP\n\n' +
                    '1. Copy the following Preview URL into the browser you wish to develop on:\n' +
                    previewUrl + '\n\n' +
                    'DEVELOPING ON HTTPS\n\n' +
                    '1. Navigate to the build file and accept the self-signed certificate:\n' +
                    'https://' + localAddress + ':' + httpsPort + '/adaptive.js\n\n' +
                    '2. Copy the following Preview URL into the browser you wish to develop on:\n' +
                    securePreviewUrl + '\n\n');

        if (autoOpen) {
            grunt.util.spawn({cmd: 'open', args: [previewUrl]}, function(){})
        } else {
            console.log('If you want to automatically open preview in your browser, please run `grunt preview --auto=true`');
        }
    });
};
