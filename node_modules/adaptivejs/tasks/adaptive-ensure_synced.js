module.exports = function(grunt) {
    /**
     * Ensures that the version of adaptivejs denoted in `package.json`
     * satisfies the currently installed version.
     */
    grunt.registerTask('adaptive-ensure_synced', function() {
        var done = this.async();
        var options = { cmd: 'npm', args: ['ls', 'adaptivejs', '-json'] };

        grunt.util.spawn(options, function(error, result, code) {
            // `npm` returns an error code of `1` when there is an invalid
            // dependency.
            if (code !== 0 && code !== 1) {
                grunt.warn('Could not retrieve the version of adaptivejs that '
                    + 'is installed');
                return done();
            }

            // `npm` sets an `invalid` property when the installed version of
            // a dependency does not satisfy the one listed in `package.json`
            var result = JSON.parse(result.stdout);

            if (result.dependencies) {
                var adaptivejs = result.dependencies['adaptivejs'];

                if (adaptivejs && adaptivejs.invalid) {
                    grunt.warn('Your package.json denotes a different version '
                        + 'of adaptivejs than the one currently installed.\r\n'
                        + 'Please run `npm install`.');
                }
            }

            done();
        });
    });    
};
